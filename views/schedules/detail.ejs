<%- include('../partials/header') %>

<style>
/* 상태별 드롭다운 색상 */
.status-confirmed {
  background-color: #198754 !important;
  color: white !important;
  border-color: #198754 !important;
}
.status-pending {
  background-color: #ffc107 !important;
  color: #000 !important;
  border-color: #ffc107 !important;
}
.status-waitlist {
  background-color: #dc3545 !important;
  color: white !important;
  border-color: #dc3545 !important;
}
.status-cancelled {
  background-color: #6c757d !important;
  color: white !important;
  border-color: #6c757d !important;
}
.status-deleted {
  background-color: #212529 !important;
  color: white !important;
  border-color: #212529 !important;
}
</style>

<div class="d-flex align-items-center mb-4 page-header">
  <a href="/schedules" class="back-link" aria-label="일정 목록으로 이동">
    <i class="bi bi-chevron-left" aria-hidden="true"></i>일정
  </a>
  <nav aria-label="현재 위치" class="mb-0">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item"><a href="/schedules">일정 관리</a></li>
      <li class="breadcrumb-item active" aria-current="page"><%= schedule.course_name %></li>
    </ol>
  </nav>
</div>

<div class="row">
  <!-- 일정 정보 -->
  <div class="col-md-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-calendar-event"></i> 일정 정보</h5>
        <% if (user && user.is_admin) { %>
        <a href="/schedules/<%= schedule.id %>/edit" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-pencil"></i>
        </a>
        <% } %>
      </div>
      <div class="card-body">
        <div class="text-center mb-3">
          <h2 class="text-success mb-0"><%= schedule.course_name %></h2>
          <p class="text-muted"><i class="bi bi-geo-alt"></i> <%= schedule.location %></p>
        </div>
        <table class="table table-borderless">
          <tr>
            <th width="30%">날짜</th>
            <td>
              <strong><%= moment(schedule.play_date).format('YYYY년 MM월 DD일') %></strong>
              <span class="badge bg-secondary"><%= moment(schedule.play_date).format('dddd') %></span>
            </td>
          </tr>
          <tr>
            <th>티타임</th>
            <td><%= schedule.tee_times || '미정' %></td>
          </tr>
          <tr>
            <th>정원</th>
            <td><%= schedule.max_members %>명</td>
          </tr>
          <tr>
            <th>상태</th>
            <td>
              <% if (schedule.status === 'open') { %>
              <span class="badge bg-success">예약가능</span>
              <% } else if (schedule.status === 'closed') { %>
              <span class="badge bg-warning">마감</span>
              <% } else if (schedule.status === 'completed') { %>
              <span class="badge bg-secondary">완료</span>
              <% } else { %>
              <span class="badge bg-danger">취소</span>
              <% } %>
            </td>
          </tr>
          <% if (schedule.notes) { %>
          <tr>
            <th>메모</th>
            <td><%= schedule.notes %></td>
          </tr>
          <% } %>
        </table>

        <!-- 예약 버튼 -->
        <% if (schedule.status === 'open') { %>
        <hr>
        <% if (myReservation && !user.is_admin) { %>
          <% if (myReservation.status !== 'cancelled') { %>
          <div class="alert alert-success mb-2 text-center">
            <i class="bi bi-check-circle"></i> 예약 신청 완료
            <% if (myReservation.status === 'waitlist') { %>
            <span class="badge bg-warning">대기자</span>
            <% } %>
          </div>
          <button type="button" class="btn btn-outline-danger w-100" onclick="cancelReservation(<%= myReservation.id %>)">
            <i class="bi bi-x-circle"></i> 예약 취소
          </button>
          <% } else { %>
          <% const teeTimesReapply = schedule.tee_times ? schedule.tee_times.split(',').map(t => t.trim()) : []; %>
          <% if (teeTimesReapply.length > 0) { %>
          <div class="mb-2">
            <label class="form-label small text-muted">희망 티타임 선택</label>
            <select id="teeTimeSelect" class="form-select">
              <% teeTimesReapply.forEach((time, idx) => { %>
              <option value="<%= time %>"><%= time %> (<%= idx + 1 %>팀)</option>
              <% }) %>
            </select>
          </div>
          <% } %>
          <button type="button" class="btn btn-success w-100" onclick="applyReservation(<%= schedule.id %>)">
            <i class="bi bi-check-circle"></i> 다시 신청
          </button>
          <% } %>
        <% } else if (user && !user.is_admin) { %>
        <% const teeTimes = schedule.tee_times ? schedule.tee_times.split(',').map(t => t.trim()) : []; %>
        <% if (teeTimes.length > 0) { %>
        <div class="mb-2">
          <label class="form-label small text-muted">희망 티타임 선택</label>
          <select id="teeTimeSelect" class="form-select">
            <% teeTimes.forEach((time, idx) => { %>
            <option value="<%= time %>"><%= time %> (<%= idx + 1 %>팀)</option>
            <% }) %>
          </select>
        </div>
        <% } %>
        <button type="button" class="btn btn-success w-100" onclick="applyReservation(<%= schedule.id %>)">
          <i class="bi bi-check-circle"></i> 예약 신청
        </button>
        <% } else if (user && user.is_admin) { %>
        <div class="alert alert-secondary mb-0 text-center">
          <i class="bi bi-info-circle"></i> 관리자는 예약 신청이 불가능합니다.
        </div>
        <% } else { %>
        <a href="/auth/login" class="btn btn-outline-success w-100">
          로그인 후 예약
        </a>
        <% } %>
        <% } %>

        <% if (user && user.is_admin && reservations.length > 0) { %>
        <hr>
        <button type="button" class="btn btn-primary w-100" onclick="assignTeams(<%= schedule.id %>)">
          <i class="bi bi-people"></i> 팀 배정
        </button>
        <% } %>
      </div>
    </div>
  </div>

  <!-- 예약자 목록 -->
  <div class="col-md-8">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-people"></i> 예약 현황
          <span class="badge bg-success"><%= reservations.filter(r => r.status !== 'cancelled').length %>/<%= schedule.max_members %></span>
        </h5>
      </div>
      <div class="card-body">
        <% if (reservations.length === 0) { %>
        <p class="text-muted text-center py-4">예약자가 없습니다.</p>
        <% } else { %>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>이름</th>
                <th>부서</th>
                <th>신청시간</th>
                <th>상태</th>
                <th>희망</th>
                <th>팀</th>
                <th>티타임</th>
                <% if (user && user.is_admin) { %>
                <th>관리</th>
                <% } %>
              </tr>
            </thead>
            <tbody>
              <% let seq = 0; %>
              <% reservations.forEach((r, index) => { %>
              <% const isInactive = ['cancelled', 'deleted'].includes(r.status); %>
              <% if (!isInactive) seq++; %>
              <% const isOverCapacity = seq > schedule.max_members && !isInactive; %>
              <tr class="<%= isInactive ? 'table-secondary text-decoration-line-through' : '' %>
                         <%= isOverCapacity ? 'table-warning' : '' %>">
                <td><%= !isInactive ? seq : '-' %></td>
                <td>
                  <strong><%= r.member_name %></strong>
                  <% if (r.priority > 0) { %>
                  <span class="badge bg-info" title="연속 참가자 (후순위)">연속</span>
                  <% } %>
                </td>
                <td><small><%= r.department || '-' %></small></td>
                <td><small><%= moment(r.applied_at).format('MM/DD HH:mm') %></small></td>
                <td>
                  <% if (user && user.is_admin) { %>
                  <%
                    // 상태별 색상 클래스
                    const statusColorClass = {
                      'confirmed': 'status-confirmed',
                      'pending': 'status-pending',
                      'waitlist': 'status-waitlist',
                      'cancelled': 'status-cancelled',
                      'deleted': 'status-deleted'
                    };
                    const currentStatus = r.status || (isOverCapacity ? 'waitlist' : 'pending');
                  %>
                  <select class="form-select form-select-sm status-select <%= statusColorClass[currentStatus] || '' %>"
                          data-reservation-id="<%= r.id %>"
                          data-member-name="<%= r.member_name %>"
                          data-original-status="<%= currentStatus %>"
                          style="width: 65px; height: 28px; font-size: 0.7rem; padding: 0.1rem 0.2rem; min-height: unset; -webkit-appearance: none;">
                    <option value="confirmed" <%= r.status === 'confirmed' ? 'selected' : '' %>>확정</option>
                    <option value="pending" <%= r.status === 'pending' ? 'selected' : '' %>>신청</option>
                    <option value="waitlist" <%= r.status === 'waitlist' || isOverCapacity ? 'selected' : '' %>>대기자</option>
                    <option value="cancelled" <%= r.status === 'cancelled' ? 'selected' : '' %>>취소</option>
                    <option value="deleted" <%= r.status === 'deleted' ? 'selected' : '' %>>삭제</option>
                  </select>
                  <% } else { %>
                    <% if (r.status === 'cancelled') { %>
                    <span class="badge bg-secondary">취소</span>
                    <% } else if (r.status === 'deleted') { %>
                    <span class="badge bg-dark">삭제</span>
                    <% } else if (r.status === 'confirmed') { %>
                    <span class="badge bg-success">확정</span>
                    <% } else if (r.status === 'waitlist' || isOverCapacity) { %>
                    <span class="badge bg-danger">대기자</span>
                    <% } else { %>
                    <span class="badge bg-warning">신청</span>
                    <% } %>
                  <% } %>
                </td>
                <td>
                  <small><%= r.preferred_tee_time || '-' %></small>
                </td>
                <td>
                  <% if (user && user.is_admin && !isInactive) { %>
                  <select class="form-select form-select-sm team-select"
                          data-reservation-id="<%= r.id %>"
                          data-swap-partner-id="<%= r.swap_partner_id || '' %>"
                          data-swap-original-team="<%= r.swap_original_team || '' %>"
                          data-member-name="<%= r.member_name %>"
                          style="width: 60px; height: 28px; font-size: 0.7rem; padding: 0.1rem 0.2rem; min-height: unset; -webkit-appearance: none;">
                    <% if (r.swap_partner_id) { %>
                    <option value="revert">원복</option>
                    <% } %>
                    <option value="">-</option>
                    <% for (let t = 1; t <= 4; t++) { %>
                    <option value="<%= t %>" <%= r.team_number === t ? 'selected' : '' %>><%= t %>팀</option>
                    <% } %>
                  </select>
                  <% } else { %>
                  <small><%= r.team_number ? r.team_number + '팀' : '-' %></small>
                  <% } %>
                </td>
                <td>
                  <% if (user && user.is_admin && !isInactive) { %>
                  <input type="time" class="form-control form-control-sm tee-time-input" data-reservation-id="<%= r.id %>" value="<%= r.tee_time || '' %>" style="width: 75px; height: 28px; font-size: 0.7rem; padding: 0.1rem 0.2rem; min-height: unset; -webkit-appearance: none;">
                  <% } else { %>
                  <small><%= r.tee_time || '-' %></small>
                  <% } %>
                </td>
                <% if (user && user.is_admin) { %>
                <td>
                  <% if (!isInactive) { %>
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteReservation(<%= r.id %>, '<%= r.member_name %>')" title="예약 삭제">
                    <i class="bi bi-trash"></i>
                  </button>
                  <% } else { %>
                  <span class="text-muted">-</span>
                  <% } %>
                </td>
                <% } %>
              </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <% } %>
      </div>
      <div class="card-footer">
        <small class="text-muted">
          <i class="bi bi-info-circle"></i>
          선착순 12명 예약 가능 (연속 참가자는 후순위 적용)
        </small>
      </div>
    </div>
  </div>
</div>

<script>
// CSRF 토큰
const csrfToken = '<%= csrfToken %>';
const scheduleId = <%= schedule.id %>;
const teeTimes = '<%= schedule.tee_times || "" %>'.split(',').map(t => t.trim()).filter(t => t);

function applyReservation(scheduleId) {
  <% if (user && user.is_admin) { %>
  alert('관리자는 예약 신청이 불가능합니다.');
  return;
  <% } %>

  const teeTimeSelect = document.getElementById('teeTimeSelect');
  const preferredTeeTime = teeTimeSelect ? teeTimeSelect.value : null;

  fetch('/reservations/apply', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken
    },
    body: JSON.stringify({
      schedule_id: scheduleId,
      preferred_tee_time: preferredTeeTime,
      _csrf: csrfToken
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(data.message + (data.isWaitlist ? ' (대기자 명단)' : ''));
      location.reload();
    } else {
      alert(data.error || '오류가 발생했습니다.');
    }
  });
}

function cancelReservation(reservationId) {
  if (!confirm('예약을 취소하시겠습니까?')) return;

  fetch('/reservations/cancel', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken
    },
    body: JSON.stringify({ reservation_id: reservationId, _csrf: csrfToken })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(data.message);
      location.reload();
    } else {
      alert(data.error || '오류가 발생했습니다.');
    }
  });
}

function assignTeams(scheduleId) {
  if (!confirm('팀 배정을 진행하시겠습니까?')) return;

  fetch(`/schedules/${scheduleId}/assign-teams`, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(data.message);
        location.reload();
      } else {
        alert(data.error || '오류가 발생했습니다.');
      }
    });
}

function deleteReservation(reservationId, memberName) {
  if (!confirm(`${memberName}님의 예약을 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) return;

  fetch('/reservations/admin/delete', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken
    },
    body: JSON.stringify({ reservation_id: reservationId, _csrf: csrfToken })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(data.message);
      location.reload();
    } else {
      alert(data.error || '오류가 발생했습니다.');
    }
  });
}

// 팀 변경 함수 (티타임 자동 연동 포함)
function updateTeam(reservationId, teamNumber, teeTime, autoTeeTime = false) {
  return fetch('/reservations/admin/update-team', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken
    },
    body: JSON.stringify({
      reservation_id: reservationId,
      team_number: teamNumber,
      tee_time: teeTime,
      auto_tee_time: autoTeeTime,
      _csrf: csrfToken
    })
  })
  .then(res => res.json());
}

// 팀 균형 정보 조회
function getTeamBalance() {
  return fetch(`/reservations/admin/team-balance/${scheduleId}`)
    .then(res => res.json());
}

// 팀 멤버 교환
function swapTeamMembers(reservationId1, reservationId2, fromTeam) {
  return fetch('/reservations/admin/swap-team', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken
    },
    body: JSON.stringify({
      reservation_id_1: reservationId1,
      reservation_id_2: reservationId2,
      from_team: fromTeam,
      _csrf: csrfToken
    })
  })
  .then(res => res.json());
}

// 팀 교환 모달 표시
function showSwapModal(fromTeam, toTeam, movedReservationId, teamMembers) {
  const toTeamMembers = teamMembers[toTeam] || [];

  if (toTeamMembers.length === 0) {
    alert(`${toTeam}팀에 교환할 멤버가 없습니다.`);
    return;
  }

  let memberOptions = toTeamMembers
    .filter(m => m.id !== movedReservationId)
    .map(m => `<option value="${m.id}">${m.member_name}</option>`)
    .join('');

  const modalHtml = `
    <div class="modal fade" id="swapModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">팀 멤버 교환</h5>
          </div>
          <div class="modal-body">
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle"></i>
              ${toTeam}팀이 5명이 되어 팀 균형이 맞지 않습니다.<br>
              ${toTeam}팀에서 ${fromTeam}팀으로 이동할 멤버를 선택해주세요.
            </div>
            <select class="form-select" id="swapMemberSelect">
              <option value="">-- 멤버 선택 --</option>
              ${memberOptions}
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="confirmSwap(${movedReservationId}, ${fromTeam}); return false;">멤버 교환</button>
          </div>
        </div>
      </div>
    </div>
  `;

  // 기존 모달 제거
  const existingModal = document.getElementById('swapModal');
  if (existingModal) existingModal.remove();

  // 모달 추가 및 표시
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  const modal = new bootstrap.Modal(document.getElementById('swapModal'));
  modal.show();
}

// 교환 확인
function confirmSwap(movedReservationId, fromTeam) {
  const selectEl = document.getElementById('swapMemberSelect');
  const swapReservationId = selectEl.value;

  if (!swapReservationId) {
    alert('교환할 멤버를 선택해주세요.');
    return;
  }

  swapTeamMembers(movedReservationId, parseInt(swapReservationId), fromTeam)
    .then(data => {
      if (data.success) {
        alert(data.message);
        location.reload();
      } else {
        alert(data.error || '오류가 발생했습니다.');
      }
    });
}

// 원복 API 호출
function revertSwap(reservationId) {
  return fetch('/reservations/admin/revert-swap', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken
    },
    body: JSON.stringify({
      reservation_id: reservationId,
      _csrf: csrfToken
    })
  })
  .then(res => res.json());
}

// 원복 확인 모달 표시
function showRevertModal(reservationId, memberName, swapPartnerName, originalTeam, partnerOriginalTeam) {
  const modalHtml = `
    <div class="modal fade" id="revertModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title"><i class="bi bi-arrow-counterclockwise"></i> 팀 원복 확인</h5>
          </div>
          <div class="modal-body">
            <div class="alert alert-info mb-3">
              <i class="bi bi-info-circle"></i>
              아래 두 멤버가 원래 팀으로 원복됩니다.
            </div>
            <div class="card mb-2">
              <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                  <span><strong>${memberName}</strong></span>
                  <span class="badge bg-primary">${originalTeam}팀으로 원복</span>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                  <span><strong>${swapPartnerName}</strong></span>
                  <span class="badge bg-primary">${partnerOriginalTeam}팀으로 원복</span>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeRevertModal()">취소</button>
            <button type="button" class="btn btn-info" onclick="confirmRevert(${reservationId})">
              <i class="bi bi-check-lg"></i> 원복 확인
            </button>
          </div>
        </div>
      </div>
    </div>
  `;

  // 기존 모달 제거
  const existingModal = document.getElementById('revertModal');
  if (existingModal) existingModal.remove();

  // 모달 추가 및 표시
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  const modal = new bootstrap.Modal(document.getElementById('revertModal'));
  modal.show();
}

// 원복 모달 닫기
function closeRevertModal() {
  const modalEl = document.getElementById('revertModal');
  const modal = bootstrap.Modal.getInstance(modalEl);
  if (modal) modal.hide();

  // 드롭다운 값 복원
  document.querySelectorAll('.team-select').forEach(select => {
    select.value = select.dataset.currentTeam || '';
  });
}

// 원복 확인
async function confirmRevert(reservationId) {
  const result = await revertSwap(reservationId);

  if (result.success) {
    const modalEl = document.getElementById('revertModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();

    alert(result.message);
    location.reload();
  } else {
    alert(result.error || '오류가 발생했습니다.');
  }
}

// 팀 선택 변경 이벤트
document.querySelectorAll('.team-select').forEach(select => {
  select.addEventListener('change', async function() {
    const reservationId = parseInt(this.dataset.reservationId);
    const selectedValue = this.value;
    const oldTeamNumber = parseInt(this.dataset.currentTeam) || 0;
    const selectElement = this;
    const row = this.closest('tr');
    const teeTimeInput = row.querySelector('.tee-time-input');

    // 원복 선택 시
    if (selectedValue === 'revert') {
      const memberName = this.dataset.memberName;
      const swapPartnerId = this.dataset.swapPartnerId;
      const originalTeam = this.dataset.swapOriginalTeam;

      // 팀 균형 정보에서 교환 상대 정보 조회
      const balanceData = await getTeamBalance();
      if (!balanceData.success) {
        alert('팀 정보를 불러올 수 없습니다.');
        this.value = oldTeamNumber || '';
        return;
      }

      // 교환 상대 찾기
      let partnerInfo = null;
      for (const teamNum in balanceData.teamMembers) {
        const member = balanceData.teamMembers[teamNum].find(m => m.id === parseInt(swapPartnerId));
        if (member) {
          partnerInfo = member;
          break;
        }
      }

      if (!partnerInfo) {
        alert('교환 상대 정보를 찾을 수 없습니다.');
        this.value = oldTeamNumber || '';
        return;
      }

      showRevertModal(reservationId, memberName, partnerInfo.member_name, originalTeam, partnerInfo.swap_original_team);
      return;
    }

    const newTeamNumber = parseInt(selectedValue);
    if (!newTeamNumber) return;

    // 먼저 팀 균형 정보 조회
    const balanceData = await getTeamBalance();

    if (!balanceData.success) {
      alert('팀 정보를 불러올 수 없습니다.');
      this.value = oldTeamNumber || '';
      return;
    }

    const { teamCounts, teamMembers, maxPerTeam } = balanceData;

    // 이동 후 대상 팀의 인원 계산 (현재 인원 + 1, 단 같은 팀 내 이동이면 제외)
    const currentTargetCount = teamCounts[newTeamNumber] || 0;
    const willExceed = oldTeamNumber !== newTeamNumber && currentTargetCount >= maxPerTeam;

    // 팀 변경 실행 (티타임 자동 연동)
    const result = await updateTeam(reservationId, newTeamNumber, null, true);

    if (!result.success) {
      alert(result.error || '오류가 발생했습니다.');
      this.value = oldTeamNumber || '';
      return;
    }

    // 티타임 UI 업데이트
    if (result.tee_time && teeTimeInput) {
      teeTimeInput.value = result.tee_time;
    }

    // 현재 팀 번호 업데이트
    this.dataset.currentTeam = newTeamNumber;

    // 성공 피드백
    selectElement.classList.add('border-success');
    setTimeout(() => selectElement.classList.remove('border-success'), 1000);

    // 팀 균형 검사 - 5명이 되면 교환 모달 표시
    if (willExceed) {
      // 최신 팀 정보 다시 조회
      const updatedBalance = await getTeamBalance();
      if (updatedBalance.success) {
        showSwapModal(oldTeamNumber, newTeamNumber, reservationId, updatedBalance.teamMembers);
      }
    }
  });
});

// 티타임 변경 이벤트
document.querySelectorAll('.tee-time-input').forEach(input => {
  input.addEventListener('change', async function() {
    const reservationId = this.dataset.reservationId;
    const teeTime = this.value;
    const inputElement = this;

    const result = await updateTeam(reservationId, null, teeTime);

    if (result.success) {
      inputElement.classList.add('border-success');
      setTimeout(() => inputElement.classList.remove('border-success'), 1000);
    } else {
      alert(result.error || '오류가 발생했습니다.');
    }
  });
});

// 초기화: 현재 팀 번호 저장
document.querySelectorAll('.team-select').forEach(select => {
  select.dataset.currentTeam = select.value;
});

// 상태 변경 함수
function updateStatus(reservationId, status) {
  return fetch('/reservations/admin/update-status', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken
    },
    body: JSON.stringify({
      reservation_id: reservationId,
      status: status,
      _csrf: csrfToken
    })
  })
  .then(res => res.json());
}

// 상태 라벨 매핑
const statusLabels = {
  'confirmed': '확정',
  'pending': '신청',
  'waitlist': '대기자',
  'cancelled': '취소',
  'deleted': '삭제'
};

// 상태별 색상 클래스
const statusColorClasses = {
  'confirmed': 'status-confirmed',
  'pending': 'status-pending',
  'waitlist': 'status-waitlist',
  'cancelled': 'status-cancelled',
  'deleted': 'status-deleted'
};

// 상태 변경 확인 및 실행
async function confirmStatusChange(selectElement, reservationId, newStatus, memberName, originalStatus) {
  const originalLabel = statusLabels[originalStatus] || originalStatus;
  const newLabel = statusLabels[newStatus] || newStatus;

  // 확인 모달 표시
  const confirmMessage = `${memberName}님의 상태를\n"${originalLabel}" → "${newLabel}"(으)로 변경하시겠습니까?`;

  if (!confirm(confirmMessage)) {
    // 취소 시 원래 상태로 복원
    selectElement.value = originalStatus;
    return;
  }

  const result = await updateStatus(reservationId, newStatus);

  if (result.success) {
    // 드롭다운 색상 업데이트
    Object.values(statusColorClasses).forEach(cls => selectElement.classList.remove(cls));
    selectElement.classList.add(statusColorClasses[newStatus] || '');
    selectElement.dataset.originalStatus = newStatus;

    // 성공 피드백
    selectElement.style.boxShadow = '0 0 5px 2px rgba(25, 135, 84, 0.5)';
    setTimeout(() => {
      selectElement.style.boxShadow = '';
      // 페이지 새로고침하여 취소선 등 스타일 반영
      location.reload();
    }, 500);
  } else {
    alert(result.error || '오류가 발생했습니다.');
    // 실패 시 원래 상태로 복원
    selectElement.value = originalStatus;
  }
}

// 상태 선택 변경 이벤트
document.querySelectorAll('.status-select').forEach(select => {
  select.addEventListener('change', function() {
    const reservationId = parseInt(this.dataset.reservationId);
    const newStatus = this.value;
    const memberName = this.dataset.memberName;
    const originalStatus = this.dataset.originalStatus;

    confirmStatusChange(this, reservationId, newStatus, memberName, originalStatus);
  });
});
</script>

<%- include('../partials/footer') %>

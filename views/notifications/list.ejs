<%- include('../partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0"><i class="bi bi-bell me-2"></i>알림 내역</h2>
  <% if (totalCount > 0) { %>
  <button class="btn btn-outline-secondary btn-sm" id="readAllBtn">
    <i class="bi bi-check2-all me-1"></i>전체 읽음
  </button>
  <% } %>
</div>

<p class="text-muted mb-4">최근 3일간의 알림 내역입니다.</p>

<% if (totalCount === 0) { %>
<div class="text-center py-5">
  <i class="bi bi-bell-slash text-muted" style="font-size: 4rem;"></i>
  <p class="text-muted mt-3">최근 3일간 받은 알림이 없습니다.</p>
</div>
<% } else { %>

<%
const dateLabels = {
  [new Date().toISOString().split('T')[0]]: '오늘',
  [new Date(Date.now() - 86400000).toISOString().split('T')[0]]: '어제',
  [new Date(Date.now() - 172800000).toISOString().split('T')[0]]: '그저께'
};

Object.keys(groupedNotifications).sort().reverse().forEach(dateKey => {
  const notifications = groupedNotifications[dateKey];
  const dateLabel = dateLabels[dateKey] || dateKey;
%>

<div class="mb-4">
  <h6 class="text-muted mb-3 border-bottom pb-2">
    <i class="bi bi-calendar3 me-2"></i><%= dateLabel %>
    <span class="badge bg-secondary ms-2"><%= notifications.length %></span>
  </h6>

  <div class="list-group">
    <% notifications.forEach(notification => { %>
    <a href="<%= notification.url %>"
       class="list-group-item list-group-item-action notification-item <%= notification.is_read ? 'read' : 'unread' %>"
       data-id="<%= notification.id %>">
      <div class="d-flex w-100 align-items-start">
        <div class="notification-icon me-3">
          <span class="badge bg-<%= notification.typeInfo.color %> rounded-circle p-2">
            <i class="bi <%= notification.typeInfo.icon %>"></i>
          </span>
        </div>
        <div class="flex-grow-1">
          <div class="d-flex w-100 justify-content-between align-items-center">
            <h6 class="mb-1 <%= notification.is_read ? 'text-muted' : '' %>">
              <%= notification.title %>
              <% if (!notification.is_read) { %>
              <span class="badge bg-danger ms-1" style="font-size: 0.6rem;">NEW</span>
              <% } %>
            </h6>
            <small class="text-muted">
              <%= notification.created_at ? new Date(notification.created_at).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : '' %>
            </small>
          </div>
          <p class="mb-1 small <%= notification.is_read ? 'text-muted' : '' %>"><%= notification.body %></p>
          <small class="text-muted">
            <span class="badge bg-<%= notification.typeInfo.color %> bg-opacity-25 text-<%= notification.typeInfo.color %>">
              <%= notification.typeInfo.label %>
            </span>
          </small>
        </div>
      </div>
    </a>
    <% }) %>
  </div>
</div>

<% }) %>

<% } %>

<style>
.notification-item {
  transition: all 0.2s ease;
  border-left: 3px solid transparent;
}

.notification-item.unread {
  background-color: #f8f9ff;
  border-left-color: #0d6efd;
}

.notification-item:hover {
  background-color: #e9ecef;
}

.notification-icon .badge {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.notification-icon .badge i {
  font-size: 1rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // 알림 클릭 시 읽음 처리
  document.querySelectorAll('.notification-item').forEach(item => {
    item.addEventListener('click', async function(e) {
      const id = this.dataset.id;
      if (!id) return;

      // 읽음 처리 (비동기, 페이지 이동과 병행)
      fetch(`/notifications/${id}/read`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).catch(err => console.error('읽음 처리 오류:', err));
    });
  });

  // 전체 읽음 버튼
  const readAllBtn = document.getElementById('readAllBtn');
  if (readAllBtn) {
    readAllBtn.addEventListener('click', async function() {
      try {
        const response = await fetch('/notifications/read-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        if (data.success) {
          // 모든 unread 항목을 read로 변경
          document.querySelectorAll('.notification-item.unread').forEach(item => {
            item.classList.remove('unread');
            item.classList.add('read');
            const badge = item.querySelector('.badge.bg-danger');
            if (badge) badge.remove();
          });
          alert(`${data.count}개의 알림을 읽음 처리했습니다.`);
        }
      } catch (err) {
        console.error('전체 읽음 처리 오류:', err);
        alert('전체 읽음 처리 중 오류가 발생했습니다.');
      }
    });
  }
});
</script>

<%- include('../partials/footer') %>

<%- include('../partials/header') %>

<!-- 페이지 헤더 -->
<div class="d-flex align-items-center justify-content-between mb-3">
  <div class="d-flex align-items-center">
    <a href="/members" class="back-link" aria-label="회원 목록으로 이동">
      <i class="bi bi-chevron-left" aria-hidden="true"></i>회원
    </a>
    <h5 class="mb-0 fw-bold"><i class="bi bi-person text-primary me-2" aria-hidden="true"></i><%= member.name %></h5>
  </div>
  <% if (user && user.is_admin) { %>
  <a href="/members/<%= member.id %>/edit" class="btn btn-outline-primary btn-sm py-1 px-3 d-flex align-items-center gap-1" style="font-size: 0.85rem;">
    <i class="bi bi-pencil-fill"></i> 정보수정
  </a>
  <% } %>
</div>

<div class="row g-3">
  <!-- 회원 정보 -->
  <div class="col-md-4">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white py-2">
        <h6 class="mb-0 fw-bold" style="font-size: 0.9rem;"><i class="bi bi-person-badge text-primary me-2"></i>회원 정보</h6>
      </div>
      <div class="card-body py-2">
        <table class="table table-borderless table-sm mb-0" style="font-size: 0.85rem;">
          <tr>
            <th width="30%" class="py-1 text-muted">이름</th>
            <td class="py-1"><strong><%= member.name %></strong></td>
          </tr>
          <tr>
            <th class="py-1 text-muted">구내번호</th>
            <td class="py-1"><%= member.internal_phone || '-' %></td>
          </tr>
          <tr>
            <th class="py-1 text-muted">부서</th>
            <td class="py-1"><%= member.department || '-' %></td>
          </tr>
          <tr>
            <th class="py-1 text-muted">직위</th>
            <td class="py-1"><%= member.position || '-' %></td>
          </tr>
          <% if (member.role) { %>
          <tr>
            <th class="py-1 text-muted">역할</th>
            <td class="py-1"><span class="badge bg-primary"><%= member.role %></span></td>
          </tr>
          <% } %>
          <tr>
            <th class="py-1 text-muted">이메일</th>
            <td class="py-1"><%= member.email || '-' %></td>
          </tr>
          <tr>
            <th class="py-1 text-muted">가입일</th>
            <td class="py-1"><%= member.join_date ? moment(member.join_date).format('YYYY-MM-DD') : '-' %></td>
          </tr>
          <tr>
            <th class="py-1 text-muted">상태</th>
            <td class="py-1">
              <% if (member.status === 'active') { %>
              <span class="badge bg-success bg-opacity-75" style="font-size: 0.85rem;">활동</span>
              <% } else if (member.status === 'inactive') { %>
              <span class="badge bg-secondary" style="font-size: 0.85rem;">탈퇴</span>
              <% } else { %>
              <span class="badge bg-warning text-dark" style="font-size: 0.85rem;">대기</span>
              <% } %>
            </td>
          </tr>
        </table>

        <% if (user && user.is_admin) { %>
        <hr class="my-2">
        <div class="d-grid">
          <button type="button" class="btn btn-outline-warning btn-sm py-1" style="font-size: 0.85rem;" onclick="resetPassword(<%= member.id %>)">
            <i class="bi bi-key"></i> 비밀번호 초기화
          </button>
        </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- 참가 이력 -->
  <div class="col-md-8">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold" style="font-size: 0.9rem;"><i class="bi bi-calendar-check text-primary me-2"></i>참가 이력 <small class="text-muted fw-normal">총 <%= participations.filter(p => p.status === 'confirmed').length %>회</small></h6>
        <% if (avgScore) { %>
        <span class="badge bg-primary" style="font-size: 0.85rem;">평균 <%= avgScore %>타</span>
        <% } %>
      </div>
      <div class="card-body p-0">
        <% if (participations.length === 0) { %>
        <div class="text-center py-5">
          <i class="bi bi-calendar-x text-muted" style="font-size: 2rem;"></i>
          <p class="text-muted mt-2 mb-0">참가 이력이 없습니다.</p>
        </div>
        <% } else { %>
        <div class="table-responsive">
          <table class="table table-hover mb-0" style="font-size: 0.85rem;">
            <thead class="table-light">
              <tr>
                <th class="py-2 ps-3">일자</th>
                <th class="py-2">골프장</th>
                <th class="py-2 text-center">상태</th>
                <th class="py-2 text-center">팀</th>
                <th class="py-2 text-center">타수</th>
                <% if (user && user.is_admin) { %>
                <th class="py-2 pe-3 text-center">관리</th>
                <% } %>
              </tr>
            </thead>
            <tbody>
              <% participations.forEach(p => { %>
              <tr>
                <td class="py-2 ps-3"><%= moment(p.play_date).format('MM/DD') %> <span class="badge bg-light text-dark" style="font-size: 0.85rem;"><%= moment(p.play_date).format('ddd') %></span></td>
                <td class="py-2"><%= p.course_name %></td>
                <td class="py-2 text-center">
                  <% if (p.status === 'confirmed') { %>
                  <span class="badge bg-success bg-opacity-75" style="font-size: 0.85rem;">확정</span>
                  <% } else if (p.status === 'pending') { %>
                  <span class="badge bg-warning text-dark" style="font-size: 0.85rem;">대기</span>
                  <% } else if (p.status === 'waitlist') { %>
                  <span class="badge bg-info" style="font-size: 0.85rem;">대기자</span>
                  <% } else { %>
                  <span class="badge bg-secondary" style="font-size: 0.85rem;">취소</span>
                  <% } %>
                </td>
                <td class="py-2 text-center"><small><%= p.team_number ? p.team_number + '팀' : '-' %></small></td>
                <td class="py-2 text-center">
                  <% if (p.score) { %>
                  <span class="badge bg-primary bg-opacity-75" style="font-size: 0.85rem;"><%= p.score %></span>
                  <% } else { %>
                  <span class="text-muted">-</span>
                  <% } %>
                </td>
                <% if (user && user.is_admin) { %>
                <td class="py-2 pe-3 text-center">
                  <button type="button" class="btn btn-outline-primary btn-sm py-0 px-1" style="font-size: 0.85rem;"
                          onclick="editScore(<%= p.id %>, <%= p.score || 'null' %>)">
                    <i class="bi bi-pencil"></i>
                  </button>
                </td>
                <% } %>
              </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- 타수 입력 모달 -->
<div class="modal fade" id="scoreModal" tabindex="-1" aria-labelledby="scoreModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title" id="scoreModalLabel"><i class="bi bi-pencil text-primary me-2"></i>타수 입력</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <input type="number" class="form-control" id="scoreInput" min="50" max="200" placeholder="타수 입력 (50~200)">
        <small class="text-muted mt-1 d-block">타수를 입력하세요. 비워두면 삭제됩니다.</small>
        <input type="hidden" id="scoreReservationId">
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary btn-sm" onclick="saveScore()">저장</button>
      </div>
    </div>
  </div>
</div>

<script>
let scoreModal;

document.addEventListener('DOMContentLoaded', function() {
  scoreModal = new bootstrap.Modal(document.getElementById('scoreModal'));
});

function resetPassword(memberId) {
  if (confirm('비밀번호를 1234로 초기화하시겠습니까?')) {
    fetch(`/members/${memberId}/reset-password`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
        } else {
          alert(data.error || '오류가 발생했습니다.');
        }
      });
  }
}

function editScore(reservationId, currentScore) {
  document.getElementById('scoreReservationId').value = reservationId;
  document.getElementById('scoreInput').value = currentScore || '';
  scoreModal.show();
}

function saveScore() {
  const reservationId = document.getElementById('scoreReservationId').value;
  const scoreValue = document.getElementById('scoreInput').value;

  const scoreNum = scoreValue === '' ? null : parseInt(scoreValue);
  if (scoreValue !== '' && (isNaN(scoreNum) || scoreNum < 50 || scoreNum > 200)) {
    alert('타수는 50~200 사이의 숫자를 입력해주세요.');
    return;
  }

  fetch(`/members/reservation/${reservationId}/score`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ score: scoreNum })
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        scoreModal.hide();
        location.reload();
      } else {
        alert(data.error || '오류가 발생했습니다.');
      }
    })
    .catch(err => {
      alert('오류가 발생했습니다.');
    });
}
</script>

<%- include('../partials/footer') %>

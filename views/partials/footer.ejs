  </main>

  <!-- 토스트 알림 컨테이너 -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header bg-primary text-white">
        <i class="bi bi-bell-fill me-2"></i>
        <strong class="me-auto" id="toastTitle">새 알림</strong>
        <small id="toastTime">방금 전</small>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastBody">
        알림 내용
      </div>
    </div>
  </div>

  <footer class="bg-light py-3 mt-5">
    <div class="container text-center text-muted">
      <small>&copy; 2024-2026 N2골프 (NH투자증권 골프동호회). All rights reserved.</small>
    </div>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/js/main.js"></script>
  <script src="/js/table-sort.js"></script>
  <!-- Vercel Analytics -->
  <script>
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/insights/script.js"></script>
  <!-- CSRF 토큰을 fetch 요청에 자동 포함 -->
  <script>
    (function() {
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
      if (csrfToken) {
        const originalFetch = window.fetch;
        window.fetch = function(url, options = {}) {
          if (['POST', 'PUT', 'DELETE'].includes((options.method || 'GET').toUpperCase())) {
            options.headers = options.headers || {};
            if (options.headers instanceof Headers) {
              options.headers.set('X-CSRF-Token', csrfToken);
            } else {
              options.headers['X-CSRF-Token'] = csrfToken;
            }
          }
          return originalFetch(url, options);
        };
      }
    })();
  </script>
  <!-- Service Worker 등록 및 푸시 알림 -->
  <script>
    (function() {
      let swRegistration = null;

      // Service Worker 등록
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
          try {
            swRegistration = await navigator.serviceWorker.register('/sw.js');
            console.log('Service Worker 등록 완료');

            // 푸시 알림 UI 초기화
            initPushNotification();
          } catch (err) {
            console.log('Service Worker 등록 실패:', err);
          }
        });
      }

      // UI 업데이트 함수
      function updatePushUI(isSubscribed) {
        const statusBadge = document.getElementById('pushStatusBadge');
        const toggleIcon = document.getElementById('pushToggleIcon');

        if (statusBadge) {
          statusBadge.textContent = isSubscribed ? 'ON' : 'OFF';
          statusBadge.className = isSubscribed
            ? 'badge bg-success ms-1'
            : 'badge bg-secondary ms-1';
          statusBadge.style.fontSize = '0.65rem';
        }

        if (toggleIcon) {
          toggleIcon.innerHTML = isSubscribed
            ? '<i class="bi bi-toggle-on text-success"></i>'
            : '<i class="bi bi-toggle-off text-secondary"></i>';
        }
      }

      // 푸시 알림 초기화
      async function initPushNotification() {
        const toggleBtn = document.getElementById('pushNotificationToggle');
        const statusBadge = document.getElementById('pushStatusBadge');

        if (!toggleBtn || !statusBadge) return;

        // 푸시 지원 여부 확인
        if (!('PushManager' in window)) {
          statusBadge.textContent = '미지원';
          statusBadge.className = 'badge bg-secondary ms-1';
          statusBadge.style.fontSize = '0.65rem';
          toggleBtn.onclick = () => alert('이 브라우저는 푸시 알림을 지원하지 않습니다.');
          return;
        }

        // 현재 권한 상태 확인
        const permission = Notification.permission;

        if (permission === 'denied') {
          statusBadge.textContent = '차단';
          statusBadge.className = 'badge bg-danger ms-1';
          statusBadge.style.fontSize = '0.65rem';
          toggleBtn.onclick = () => alert('알림이 차단되어 있습니다. 브라우저 설정에서 알림을 허용해주세요.');
          return;
        }

        // 구독 상태 확인
        try {
          const subscription = await swRegistration?.pushManager.getSubscription();
          updatePushUI(!!subscription);

          // 토글 클릭 이벤트
          toggleBtn.onclick = async (e) => {
            e.preventDefault();
            await togglePushSubscription();
          };
        } catch (err) {
          console.error('푸시 상태 확인 오류:', err);
          statusBadge.textContent = '오류';
          statusBadge.className = 'badge bg-warning ms-1';
          statusBadge.style.fontSize = '0.65rem';
        }
      }

      // 푸시 구독 토글
      async function togglePushSubscription() {
        const statusBadge = document.getElementById('pushStatusBadge');
        if (!swRegistration) return;

        try {
          const subscription = await swRegistration.pushManager.getSubscription();

          if (subscription) {
            // 구독 해제
            await unsubscribePush(subscription);
          } else {
            // 구독 등록
            await subscribePush();
          }
        } catch (err) {
          console.error('푸시 토글 오류:', err);
          alert('알림 설정 변경 중 오류가 발생했습니다.');
        }
      }

      // 푸시 구독
      async function subscribePush() {
        try {
          // 알림 권한 요청
          const permission = await Notification.requestPermission();
          if (permission !== 'granted') {
            alert('알림 권한이 필요합니다.');
            return;
          }

          // VAPID 공개키 가져오기
          const response = await fetch('/api/push/vapid-public-key');
          const data = await response.json();

          if (!data.success) {
            alert(data.error || '푸시 서비스를 사용할 수 없습니다.');
            return;
          }

          // 구독 생성
          const subscription = await swRegistration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(data.publicKey)
          });

          // 서버에 구독 정보 전송
          const subscribeResponse = await fetch('/api/push/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ subscription })
          });

          const subscribeData = await subscribeResponse.json();

          if (subscribeData.success) {
            updatePushUI(true);
            alert('알림이 활성화되었습니다.');
          } else {
            throw new Error(subscribeData.error);
          }
        } catch (err) {
          console.error('푸시 구독 오류:', err);
          alert('알림 활성화에 실패했습니다: ' + err.message);
        }
      }

      // 푸시 구독 해제
      async function unsubscribePush(subscription) {
        try {
          // 서버에서 구독 삭제
          await fetch('/api/push/unsubscribe', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ endpoint: subscription.endpoint })
          });

          // 브라우저에서 구독 해제
          await subscription.unsubscribe();

          updatePushUI(false);
          alert('알림이 비활성화되었습니다.');
        } catch (err) {
          console.error('푸시 구독 해제 오류:', err);
          alert('알림 비활성화에 실패했습니다.');
        }
      }

      // Base64 URL을 Uint8Array로 변환
      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }
    })();
  </script>
  <!-- 개인 통계 롤링 카드 -->
  <script>
    (function() {
      const carousel = document.getElementById('statsCarousel');
      const indicators = document.querySelectorAll('.stats-indicator');
      if (!carousel || indicators.length === 0) return;

      let currentIndex = 0;
      const totalSlides = 4;
      const intervalTime = 4000;

      function goToSlide(index) {
        currentIndex = index;
        carousel.style.transform = `translateX(-${index * 25}%)`;
        indicators.forEach((ind, i) => {
          ind.classList.toggle('active', i === index);
        });
      }

      function nextSlide() {
        goToSlide((currentIndex + 1) % totalSlides);
      }

      // 자동 롤링
      let autoSlide = setInterval(nextSlide, intervalTime);

      // 인디케이터 클릭
      indicators.forEach((ind, i) => {
        ind.addEventListener('click', () => {
          clearInterval(autoSlide);
          goToSlide(i);
          autoSlide = setInterval(nextSlide, intervalTime);
        });
      });

      // 터치 스와이프 지원
      let touchStartX = 0;
      let touchEndX = 0;

      carousel.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });

      carousel.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      }, { passive: true });

      function handleSwipe() {
        const diff = touchStartX - touchEndX;
        if (Math.abs(diff) > 50) {
          clearInterval(autoSlide);
          if (diff > 0) {
            goToSlide((currentIndex + 1) % totalSlides);
          } else {
            goToSlide((currentIndex - 1 + totalSlides) % totalSlides);
          }
          autoSlide = setInterval(nextSlide, intervalTime);
        }
      }
    })();
  </script>
  <!-- 읽지 않은 알림 개수 조회 및 토스트 표시 -->
  <script>
    (function() {
      // 마지막으로 확인한 알림 ID (세션 스토리지에 저장)
      const LAST_SEEN_KEY = 'lastSeenNotificationId';
      // 페이지 로드 시 토스트 표시 여부 (세션당 1회)
      const TOAST_SHOWN_KEY = 'toastShownThisSession';

      // 알림 배지 업데이트
      function updateUnreadBadge(count) {
        const badge = document.getElementById('unreadBadge');
        const badgeMenu = document.getElementById('unreadBadgeMenu');

        if (badge) {
          if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = 'inline';
          } else {
            badge.style.display = 'none';
          }
        }

        if (badgeMenu) {
          if (count > 0) {
            badgeMenu.textContent = count;
            badgeMenu.style.display = 'inline';
          } else {
            badgeMenu.style.display = 'none';
          }
        }
      }

      // 토스트 알림 표시
      function showToast(title, body, url) {
        const toastEl = document.getElementById('notificationToast');
        const toastTitle = document.getElementById('toastTitle');
        const toastBody = document.getElementById('toastBody');

        if (!toastEl) return;

        toastTitle.textContent = title;
        toastBody.innerHTML = `<a href="${url}" class="text-decoration-none text-dark">${body}</a>`;

        const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
        toast.show();
      }

      // 알림 개수 조회 및 새 알림 확인
      async function checkNotifications(isInitialLoad = false) {
        try {
          const response = await fetch('/notifications/unread-count');
          const data = await response.json();

          if (data.success) {
            updateUnreadBadge(data.count);

            // 읽지 않은 알림이 있을 때 토스트 표시 조건 확인
            if (data.count > 0) {
              const lastSeenId = parseInt(sessionStorage.getItem(LAST_SEEN_KEY) || '0');
              const toastShown = sessionStorage.getItem(TOAST_SHOWN_KEY);

              // 최신 알림 조회
              const latestResponse = await fetch('/notifications/latest');
              const latestData = await latestResponse.json();

              if (latestData.success && latestData.notification) {
                const latest = latestData.notification;

                // 토스트 표시 조건:
                // 1. 새로운 알림 ID (기존 로직)
                // 2. 또는 페이지 첫 로드 시 아직 토스트를 안 보여준 경우
                const isNewNotification = latest.id > lastSeenId;
                const shouldShowOnFirstLoad = isInitialLoad && !toastShown && data.count > 0;

                if (isNewNotification || shouldShowOnFirstLoad) {
                  showToast(latest.title, latest.body, latest.url);
                  sessionStorage.setItem(LAST_SEEN_KEY, latest.id.toString());
                  sessionStorage.setItem(TOAST_SHOWN_KEY, 'true');
                }
              }
            }
          }
        } catch (err) {
          console.error('알림 확인 오류:', err);
        }
      }

      // 페이지 로드 시 알림 확인
      document.addEventListener('DOMContentLoaded', function() {
        // 로그인 상태인 경우에만 실행
        const unreadBadge = document.getElementById('unreadBadge');
        if (unreadBadge) {
          // 첫 로드 시 토스트 표시 플래그 초기화 (페이지 새로고침마다)
          sessionStorage.removeItem(TOAST_SHOWN_KEY);

          checkNotifications(true); // isInitialLoad = true

          // 30초마다 새 알림 확인
          setInterval(() => checkNotifications(false), 30000);
        }
      });
    })();
  </script>
</body>
</html>

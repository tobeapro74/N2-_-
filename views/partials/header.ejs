<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <!-- PWA 메타태그 -->
  <meta name="theme-color" content="#198754">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="N2골프">
  <meta name="application-name" content="N2골프">
  <meta name="description" content="NH투자증권 N2골프 동호회 자금 및 예약 관리">
  <!-- PWA 매니페스트 -->
  <link rel="manifest" href="/manifest.json">
  <!-- 아이콘 -->
  <link rel="icon" type="image/svg+xml" href="/icons/icon.svg">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">
  <!-- CSRF 토큰 저장 -->
  <meta name="csrf-token" content="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
</head>
<body>
  <!-- 전역 로딩 오버레이 (모든 페이지에서 사용) -->
  <div id="globalLoadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
      <div class="spinner-border text-primary" role="status" style="width: 2.5rem; height: 2.5rem;">
        <span class="visually-hidden">로딩중...</span>
      </div>
      <div class="loading-text mt-2">조회중...</div>
    </div>
  </div>
  <!-- Pull-to-Refresh 인디케이터 -->
  <div id="pullToRefreshIndicator" class="pull-to-refresh-indicator">
    <i class="bi bi-arrow-down-circle pull-to-refresh-icon"></i>
    <span class="pull-to-refresh-text">당겨서 새로고침</span>
  </div>
  <!-- 로딩 인디케이터 즉시 초기화 스크립트 -->
  <script>
    (function() {
      var loadingOverlay = document.getElementById('globalLoadingOverlay');
      var isLoading = false;
      var loadingTimeout;

      function showLoading() {
        if (isLoading || !loadingOverlay) return;
        isLoading = true;
        loadingOverlay.style.display = 'flex';
        clearTimeout(loadingTimeout);
        loadingTimeout = setTimeout(hideLoading, 5000);
      }

      function hideLoading() {
        isLoading = false;
        if (loadingOverlay) loadingOverlay.style.display = 'none';
        clearTimeout(loadingTimeout);
      }

      function isValidNavigationLink(element) {
        if (!element) return false;
        var href = element.getAttribute('href');
        if (!href || href === '' || href.startsWith('#') ||
            href.startsWith('javascript:') || href.startsWith('tel:') ||
            href.startsWith('mailto:') ||
            element.getAttribute('target') === '_blank' ||
            element.hasAttribute('data-bs-toggle') ||
            element.classList.contains('no-loading') ||
            element.classList.contains('dropdown-toggle')) {
          return false;
        }
        return href.startsWith('/') || href.startsWith(window.location.origin);
      }

      function handleClick(e) {
        if (isLoading) return;
        var linkTarget = e.target.closest('a');
        if (isValidNavigationLink(linkTarget)) {
          showLoading();
          return;
        }
        var onclickTarget = e.target.closest('[onclick*="location.href"]');
        if (onclickTarget && !onclickTarget.classList.contains('no-loading')) {
          showLoading();
        }
      }

      // 클릭 이벤트 리스너 등록
      document.addEventListener('click', handleClick);

      // 폼 제출 시 로딩 표시
      document.addEventListener('submit', function(e) {
        if (isLoading) return;
        var form = e.target;
        if (!form.classList.contains('no-loading') && !form.hasAttribute('data-no-loading')) {
          showLoading();
        }
      });

      // 페이지 표시 시 로딩 숨김 (뒤로가기/앞으로가기)
      window.addEventListener('pageshow', hideLoading);

      // 페이지 로드 완료 시 로딩 숨김
      window.addEventListener('load', hideLoading);

      // 탭 전환 시 로딩 숨김
      document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') hideLoading();
      });

      // 페이지 이동 시작 시 로딩 표시
      window.addEventListener('beforeunload', showLoading);

      // 전역 함수로 노출 (필요시 다른 스크립트에서 사용 가능)
      window.showGlobalLoading = showLoading;
      window.hideGlobalLoading = hideLoading;
    })();
  </script>
  <!-- Pull-to-Refresh 스크립트 -->
  <script>
    (function() {
      // 홈, 일상톡톡, 골프일정 톡톡 페이지에서 동작 (모바일만)
      var path = window.location.pathname;
      var isPullToRefreshPage = path === '/' ||
                                 path === '/community' ||
                                 /^\/schedules\/\d+\/community$/.test(path);
      if (!isPullToRefreshPage || !('ontouchstart' in window)) return;

      var indicator = document.getElementById('pullToRefreshIndicator');
      var textEl = indicator ? indicator.querySelector('.pull-to-refresh-text') : null;
      if (!indicator || !textEl) return;

      var startY = 0;
      var currentY = 0;
      var pulling = false;
      var refreshing = false;
      var PULL_THRESHOLD = 80;  // 새로고침 트리거 거리 (px)
      var MAX_PULL = 120;

      function isAtTop() {
        return window.scrollY <= 0;
      }

      document.addEventListener('touchstart', function(e) {
        if (refreshing || !isAtTop()) return;
        startY = e.touches[0].clientY;
        pulling = false;
      }, { passive: true });

      document.addEventListener('touchmove', function(e) {
        if (refreshing || !isAtTop() || startY === 0) return;

        currentY = e.touches[0].clientY;
        var deltaY = currentY - startY;

        // 아래로 당기는 경우만 처리
        if (deltaY > 20) {
          pulling = true;
          var pullDistance = Math.min(deltaY, MAX_PULL);
          var progress = pullDistance / PULL_THRESHOLD;

          indicator.classList.add('pulling');

          if (pullDistance >= PULL_THRESHOLD) {
            textEl.textContent = '놓으면 새로고침';
          } else {
            textEl.textContent = '당겨서 새로고침';
          }
        }
      }, { passive: true });

      document.addEventListener('touchend', function(e) {
        if (!pulling || refreshing) {
          startY = 0;
          return;
        }

        var deltaY = currentY - startY;

        if (deltaY >= PULL_THRESHOLD) {
          // 새로고침 실행
          refreshing = true;
          indicator.classList.remove('pulling');
          indicator.classList.add('refreshing');
          textEl.textContent = '조회중...';

          // 로딩 오버레이 표시 후 새로고침
          if (window.showGlobalLoading) window.showGlobalLoading();

          setTimeout(function() {
            window.location.reload();
          }, 300);
        } else {
          // 임계값 미달 - 원래 상태로
          indicator.classList.remove('pulling');
        }

        startY = 0;
        currentY = 0;
        pulling = false;
      }, { passive: true });

      // 터치 취소 시
      document.addEventListener('touchcancel', function() {
        indicator.classList.remove('pulling');
        startY = 0;
        currentY = 0;
        pulling = false;
      }, { passive: true });
    })();
  </script>

  <!-- 스킵 링크 (접근성) -->
  <a href="#main-content" class="skip-link">본문으로 바로가기</a>

  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm py-1" role="navigation" aria-label="메인 네비게이션">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center py-0" href="/">
        <img src="/images/2966632B-A70E-43C4-96FF-E05CD029B17D_1_201_a.jpeg" alt="로고" class="logo-img me-1 me-sm-2">
        <span class="text-success fw-semibold logo-text">Namuh on the Green</span>
      </a>
      <% if (user) { %>
      <span class="text-dark ms-auto me-2" style="font-size: 0.85rem;"><%= user.name %>님 반갑습니다</span>
      <% } %>
      <button class="navbar-toggler border-0 p-1" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="메뉴 열기">
        <i class="bi bi-list" style="font-size: 1.25rem;"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link text-dark" href="/"><i class="bi bi-house-door me-2" aria-hidden="true"></i>대시보드</a>
          </li>
          <% if (user) { %>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-dark" href="#" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-calendar-check me-2" aria-hidden="true"></i>예약
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/reservations/available">예약 신청</a></li>
              <li><a class="dropdown-item" href="/reservations">내 예약</a></li>
              <% if (user.is_admin) { %>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/reservations/admin">예약 관리</a></li>
              <% } %>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-dark" href="#" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-calendar-week me-2" aria-hidden="true"></i>일정
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/schedules">일정 목록</a></li>
              <% if (user.is_admin) { %>
              <li><a class="dropdown-item" href="/schedules/new">일정 생성</a></li>
              <li><a class="dropdown-item" href="/schedules/generate">연간 일정 생성</a></li>
              <% } %>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-dark" href="#" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-wallet2 me-2" aria-hidden="true"></i>자금
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/finance">자금 현황</a></li>
              <li><a class="dropdown-item" href="/finance/income">입금 내역</a></li>
              <li><a class="dropdown-item" href="/finance/expense">출금 내역</a></li>
              <% if (user.is_admin) { %>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/finance/fees">회비 관리</a></li>
              <% } %>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" href="/members"><i class="bi bi-people-fill me-2" aria-hidden="true"></i>회원</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-dark position-relative" href="#" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-bell me-2" aria-hidden="true"></i>알림
              <span id="unreadBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem; display: none;">
                0
              </span>
              <span id="pushStatusBadge" class="badge bg-secondary ms-1" style="font-size: 0.65rem;">확인중</span>
            </a>
            <ul class="dropdown-menu">
              <li>
                <a class="dropdown-item d-flex align-items-center justify-content-between no-loading" href="#" id="pushNotificationToggle">
                  <span>알림 받기</span>
                  <span id="pushToggleIcon" class="ms-2"><i class="bi bi-toggle-off text-secondary"></i></span>
                </a>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/notifications">알림 내역 <span id="unreadBadgeMenu" class="badge bg-danger" style="display: none;">0</span></a></li>
            </ul>
          </li>
          <% } %>
        </ul>
        <ul class="navbar-nav align-items-center">
          <% if (user) { %>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-dark" href="#" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-person-circle me-2" aria-hidden="true"></i><span class="d-lg-none"><%= user.name %></span>
              <% if (user.is_admin) { %><span class="badge bg-warning text-dark ms-1">관리자</span><% } %>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="/auth/change-password">비밀번호 변경</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/auth/logout">로그아웃</a></li>
            </ul>
          </li>
          <% } else { %>
          <li class="nav-item">
            <a class="nav-link text-dark" href="/auth/login"><i class="bi bi-box-arrow-in-right me-2" aria-hidden="true"></i>로그인</a>
          </li>
          <% } %>
        </ul>
      </div>
    </div>
  </nav>

  <% if (typeof breadcrumb !== 'undefined' && breadcrumb && breadcrumb.length > 0) { %>
  <nav class="breadcrumb-nav" aria-label="현재 위치">
    <div class="container">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/"><i class="bi bi-house-door" aria-hidden="true"></i> 홈</a></li>
        <% breadcrumb.forEach((item, index) => { %>
          <% if (index === breadcrumb.length - 1) { %>
            <li class="breadcrumb-item active" aria-current="page"><%= item.label %></li>
          <% } else { %>
            <li class="breadcrumb-item"><a href="<%= item.url %>"><%= item.label %></a></li>
          <% } %>
        <% }) %>
      </ol>
    </div>
  </nav>
  <% } %>

  <main id="main-content" class="container py-4" role="main">

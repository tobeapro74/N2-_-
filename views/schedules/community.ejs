<%- include('../partials/header') %>

<!-- 페이지 헤더 -->
<div class="d-flex align-items-center justify-content-between mb-3">
  <div class="d-flex align-items-center">
    <a href="/schedules/<%= schedule.id %>" class="back-link" aria-label="일정 상세로 이동">
      <i class="bi bi-chevron-left" aria-hidden="true"></i>일정
    </a>
    <h5 class="mb-0 fw-bold"><i class="bi bi-chat-dots text-success me-2" aria-hidden="true"></i>커뮤니티</h5>
  </div>
</div>

<!-- 일정 정보 요약 -->
<div class="card border-0 shadow-sm mb-3">
  <div class="card-body py-2 px-3">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <span class="fw-bold text-success"><%= schedule.course_name %></span>
        <span class="text-muted ms-2" style="font-size: 0.85rem;"><%= schedule.location %></span>
      </div>
      <div class="text-end">
        <span class="badge bg-light text-dark"><%= moment(schedule.play_date).format('YYYY.MM.DD (ddd)') %></span>
        <% if (schedule.tee_times) { %>
        <small class="text-muted ms-1"><%= schedule.tee_times %></small>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- 댓글 작성 폼 -->
<div class="card border-0 shadow-sm mb-3">
  <div class="card-body py-2 px-3">
    <form id="commentForm">
      <div class="d-flex gap-2 align-items-center">
        <div class="flex-grow-1 d-flex gap-1 align-items-center">
          <textarea id="commentInput" class="form-control form-control-sm" placeholder="댓글을 입력하세요... (Shift+Enter: 줄바꿈)" maxlength="500" rows="1" style="resize: none; overflow-y: hidden; line-height: 1.5; padding-top: 6px; padding-bottom: 6px;"></textarea>
          <label for="imageInput" class="btn btn-outline-secondary btn-sm px-2 d-flex align-items-center justify-content-center" style="height: 31px; cursor: pointer;" title="이미지 첨부">
            <i class="bi bi-image"></i>
          </label>
          <input type="file" id="imageInput" accept="image/jpeg,image/png,image/gif,image/webp" class="d-none">
        </div>
        <button type="submit" id="submitBtn" class="btn btn-success btn-sm px-3 d-flex align-items-center justify-content-center" style="height: 31px;">
          <i class="bi bi-send"></i>
        </button>
      </div>
      <small class="text-muted mt-1 d-block" style="font-size: 0.7rem;">이미지: 최대 5MB (jpg, png, gif, webp)</small>
    </form>
  </div>
</div>

<!-- 댓글 목록 -->
<div id="commentsContainer">
  <div class="text-center py-4">
    <div class="spinner-border spinner-border-sm text-success" role="status">
      <span class="visually-hidden">로딩 중...</span>
    </div>
  </div>
</div>

<!-- 댓글 템플릿 -->
<template id="commentTemplate">
  <div class="card border-0 shadow-sm mb-2 comment-card" data-comment-id="">
    <div class="card-body py-2 px-3">
      <!-- 댓글 헤더 -->
      <div class="d-flex align-items-center justify-content-between mb-1">
        <div class="d-flex align-items-center">
          <span class="fw-bold comment-author" style="font-size: 0.85rem;"></span>
          <small class="text-muted ms-2 comment-time"></small>
        </div>
        <div class="comment-actions">
          <button class="btn btn-link btn-sm text-muted p-0 me-2 edit-btn" style="font-size: 0.75rem;" title="수정">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-link btn-sm text-danger p-0 delete-btn" style="font-size: 0.75rem;" title="삭제">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
      <!-- 댓글 이미지 -->
      <div class="comment-image-container d-none mb-2">
        <img class="comment-image rounded" src="" alt="첨부 이미지" style="max-height: 300px; max-width: 100%; cursor: pointer;" onclick="window.open(this.src, '_blank')" onerror="this.parentElement.classList.add('d-none')">
      </div>
      <!-- 댓글 내용 -->
      <p class="mb-2 comment-content" style="font-size: 0.9rem;"></p>
      <!-- 수정 폼 (숨김) -->
      <div class="edit-form d-none mb-2">
        <div class="d-flex gap-2 align-items-end">
          <textarea class="form-control form-control-sm edit-input" maxlength="500" rows="2" style="resize: none;"></textarea>
          <div class="d-flex flex-column gap-1">
            <button class="btn btn-success btn-sm save-edit-btn">저장</button>
            <button class="btn btn-outline-secondary btn-sm cancel-edit-btn">취소</button>
          </div>
        </div>
      </div>
      <!-- 액션 버튼 -->
      <div class="d-flex align-items-center gap-3">
        <button class="btn btn-link btn-sm p-0 like-btn" style="font-size: 0.8rem;">
          <i class="bi bi-hand-thumbs-up"></i>
          <span class="likes-count">0</span>
        </button>
        <button class="btn btn-link btn-sm p-0 dislike-btn" style="font-size: 0.8rem;">
          <i class="bi bi-hand-thumbs-down"></i>
          <span class="dislikes-count">0</span>
        </button>
        <button class="btn btn-link btn-sm p-0 text-muted reply-btn" style="font-size: 0.8rem;">
          답글
        </button>
      </div>
      <!-- 답글 폼 (숨김) -->
      <div class="reply-form d-none mt-2">
        <div class="d-flex gap-2 align-items-end">
          <textarea class="form-control form-control-sm reply-input" placeholder="답글을 입력하세요... (Shift+Enter: 줄바꿈)" maxlength="500" rows="1" style="resize: none; overflow-y: hidden;"></textarea>
          <div class="d-flex gap-1">
            <button class="btn btn-success btn-sm submit-reply-btn">등록</button>
            <button class="btn btn-outline-secondary btn-sm cancel-reply-btn">취소</button>
          </div>
        </div>
      </div>
      <!-- 대댓글 목록 -->
      <div class="replies-container mt-2"></div>
    </div>
  </div>
</template>

<!-- 대댓글 템플릿 -->
<template id="replyTemplate">
  <div class="reply-card border-start border-2 border-success ps-3 py-1 mb-1" data-comment-id="">
    <div class="d-flex align-items-center justify-content-between mb-1">
      <div class="d-flex align-items-center">
        <span class="fw-bold reply-author" style="font-size: 0.8rem;"></span>
        <small class="text-muted ms-2 reply-time"></small>
      </div>
      <div class="reply-actions">
        <button class="btn btn-link btn-sm text-muted p-0 me-2 edit-btn" style="font-size: 0.7rem;" title="수정">
          <i class="bi bi-pencil"></i>
        </button>
        <button class="btn btn-link btn-sm text-danger p-0 delete-btn" style="font-size: 0.7rem;" title="삭제">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>
    <!-- 대댓글 이미지 -->
    <div class="reply-image-container d-none mb-1">
      <img class="reply-image rounded" src="" alt="첨부 이미지" style="max-height: 200px; max-width: 100%; cursor: pointer;" onclick="window.open(this.src, '_blank')" onerror="this.parentElement.classList.add('d-none')">
    </div>
    <p class="mb-1 reply-content" style="font-size: 0.85rem;"></p>
    <!-- 수정 폼 (숨김) -->
    <div class="edit-form d-none mb-1">
      <div class="d-flex gap-2 align-items-end">
        <textarea class="form-control form-control-sm edit-input" maxlength="500" rows="2" style="resize: none;"></textarea>
        <div class="d-flex gap-1">
          <button class="btn btn-success btn-sm save-edit-btn" style="font-size: 0.75rem;">저장</button>
          <button class="btn btn-outline-secondary btn-sm cancel-edit-btn" style="font-size: 0.75rem;">취소</button>
        </div>
      </div>
    </div>
    <div class="d-flex align-items-center gap-3">
      <button class="btn btn-link btn-sm p-0 like-btn" style="font-size: 0.75rem;">
        <i class="bi bi-hand-thumbs-up"></i>
        <span class="likes-count">0</span>
      </button>
      <button class="btn btn-link btn-sm p-0 dislike-btn" style="font-size: 0.75rem;">
        <i class="bi bi-hand-thumbs-down"></i>
        <span class="dislikes-count">0</span>
      </button>
    </div>
  </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const scheduleId = <%= schedule.id %>;
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  const commentsContainer = document.getElementById('commentsContainer');
  const commentTemplate = document.getElementById('commentTemplate');
  const replyTemplate = document.getElementById('replyTemplate');
  const commentForm = document.getElementById('commentForm');
  const commentInput = document.getElementById('commentInput');

  // 이미지 관련 요소
  const imageInput = document.getElementById('imageInput');
  const imageLabel = document.querySelector('label[for="imageInput"]');
  let selectedImageUrl = null; // 업로드된 이미지 URL 저장
  let isUploading = false;

  // 이미지 선택 처리 (미리보기 없이 바로 업로드)
  imageInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // 파일 크기 체크 (5MB)
    if (file.size > 5 * 1024 * 1024) {
      alert('이미지 크기는 5MB를 초과할 수 없습니다.');
      imageInput.value = '';
      return;
    }

    // 업로드 중 표시
    isUploading = true;
    imageLabel.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    imageLabel.style.pointerEvents = 'none';

    // 서버에 업로드
    const formData = new FormData();
    formData.append('image', file);

    try {
      const response = await fetch('/schedules/comments/upload-image', {
        method: 'POST',
        headers: { 'X-CSRF-Token': csrfToken },
        body: formData
      });

      const data = await response.json();

      if (data.success) {
        selectedImageUrl = data.imageUrl;
        console.log('이미지 업로드 완료:', { imageUrl: selectedImageUrl, storageType: data.storageType });
        // 업로드 성공 표시 (체크 아이콘)
        imageLabel.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
      } else {
        alert(data.error || '이미지 업로드에 실패했습니다.');
        resetImageUpload();
      }
    } catch (error) {
      console.error('이미지 업로드 오류:', error);
      alert('이미지 업로드 중 오류가 발생했습니다.');
      resetImageUpload();
    } finally {
      isUploading = false;
      imageLabel.style.pointerEvents = 'auto';
    }
  });

  function resetImageUpload() {
    imageInput.value = '';
    imageLabel.innerHTML = '<i class="bi bi-image"></i>';
    selectedImageUrl = null;
  }

  // textarea 자동 높이 조절 및 Enter/Shift+Enter 처리
  function setupTextarea(textarea, onSubmit) {
    // 자동 높이 조절
    const autoResize = () => {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    };

    textarea.addEventListener('input', autoResize);

    // Enter: 전송, Shift+Enter: 줄바꿈
    textarea.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (textarea.value.trim()) {
          onSubmit();
        }
      }
    });
  }

  // 메인 댓글 입력창 설정 (이미지가 있으면 텍스트 없어도 전송 가능)
  commentInput.addEventListener('input', () => {
    commentInput.style.height = 'auto';
    commentInput.style.height = Math.min(commentInput.scrollHeight, 120) + 'px';
  });

  commentInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      // 텍스트 또는 이미지가 있으면 전송
      if (commentInput.value.trim() || selectedImageUrl) {
        commentForm.dispatchEvent(new Event('submit'));
      }
    }
  });

  // 댓글 로드
  async function loadComments() {
    try {
      const response = await fetch(`/schedules/${scheduleId}/comments`, {
        headers: { 'X-CSRF-Token': csrfToken }
      });
      const data = await response.json();

      if (data.comments) {
        renderComments(data.comments);
      }
    } catch (error) {
      console.error('댓글 로드 오류:', error);
      commentsContainer.innerHTML = '<div class="text-center text-muted py-4">댓글을 불러오는 중 오류가 발생했습니다.</div>';
    }
  }

  // 댓글 렌더링
  function renderComments(comments) {
    if (comments.length === 0) {
      commentsContainer.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-chat-dots me-2"></i>첫 번째 댓글을 남겨보세요!</div>';
      return;
    }

    commentsContainer.innerHTML = '';

    comments.forEach(comment => {
      const commentEl = createCommentElement(comment);
      commentsContainer.appendChild(commentEl);
    });
  }

  // 댓글 요소 생성
  function createCommentElement(comment) {
    const clone = commentTemplate.content.cloneNode(true);
    const card = clone.querySelector('.comment-card');

    card.dataset.commentId = comment.id;
    card.querySelector('.comment-author').textContent = comment.member_name;
    card.querySelector('.comment-time').textContent = formatTime(comment.created_at);
    card.querySelector('.comment-content').innerHTML = linkify(comment.content || '');
    card.querySelector('.likes-count').textContent = comment.likes || 0;
    card.querySelector('.dislikes-count').textContent = comment.dislikes || 0;

    // 이미지 표시
    if (comment.image_url) {
      const imageContainer = card.querySelector('.comment-image-container');
      const imageEl = card.querySelector('.comment-image');
      // 이미지 로드 성공 시 표시
      imageEl.onload = () => {
        imageContainer.classList.remove('d-none');
      };
      imageEl.onerror = () => {
        console.error('이미지 로드 실패:', comment.image_url);
        imageContainer.classList.add('d-none');
      };
      imageEl.src = comment.image_url;
      // 이미지가 이미 캐시되어 있으면 바로 표시
      if (imageEl.complete && imageEl.naturalHeight > 0) {
        imageContainer.classList.remove('d-none');
      }
    }

    // 좋아요/싫어요 상태 반영
    const likeBtn = card.querySelector('.like-btn');
    const dislikeBtn = card.querySelector('.dislike-btn');

    if (comment.my_reaction === 'like') {
      likeBtn.classList.add('text-primary');
    } else if (comment.my_reaction === 'dislike') {
      dislikeBtn.classList.add('text-danger');
    }

    // 수정/삭제 버튼 표시 여부
    const actionsDiv = card.querySelector('.comment-actions');
    if (!comment.is_mine && !comment.is_admin) {
      actionsDiv.style.display = 'none';
    }

    // 이벤트 리스너 등록
    setupCommentEventListeners(card, comment);

    // 대댓글 렌더링
    if (comment.replies && comment.replies.length > 0) {
      const repliesContainer = card.querySelector('.replies-container');
      comment.replies.forEach(reply => {
        const replyEl = createReplyElement(reply);
        repliesContainer.appendChild(replyEl);
      });
    }

    return clone;
  }

  // 대댓글 요소 생성
  function createReplyElement(reply) {
    const clone = replyTemplate.content.cloneNode(true);
    const card = clone.querySelector('.reply-card');

    card.dataset.commentId = reply.id;
    card.querySelector('.reply-author').textContent = reply.member_name;
    card.querySelector('.reply-time').textContent = formatTime(reply.created_at);
    card.querySelector('.reply-content').innerHTML = linkify(reply.content || '');
    card.querySelector('.likes-count').textContent = reply.likes || 0;
    card.querySelector('.dislikes-count').textContent = reply.dislikes || 0;

    // 이미지 표시
    if (reply.image_url) {
      const imageContainer = card.querySelector('.reply-image-container');
      const imageEl = card.querySelector('.reply-image');
      // 이미지 로드 성공 시 표시
      imageEl.onload = () => {
        imageContainer.classList.remove('d-none');
      };
      imageEl.onerror = () => {
        console.error('이미지 로드 실패:', reply.image_url);
        imageContainer.classList.add('d-none');
      };
      imageEl.src = reply.image_url;
      // 이미지가 이미 캐시되어 있으면 바로 표시
      if (imageEl.complete && imageEl.naturalHeight > 0) {
        imageContainer.classList.remove('d-none');
      }
    }

    // 좋아요/싫어요 상태 반영
    const likeBtn = card.querySelector('.like-btn');
    const dislikeBtn = card.querySelector('.dislike-btn');

    if (reply.my_reaction === 'like') {
      likeBtn.classList.add('text-primary');
    } else if (reply.my_reaction === 'dislike') {
      dislikeBtn.classList.add('text-danger');
    }

    // 수정/삭제 버튼 표시 여부
    const actionsDiv = card.querySelector('.reply-actions');
    if (!reply.is_mine && !reply.is_admin) {
      actionsDiv.style.display = 'none';
    }

    // 이벤트 리스너 등록
    setupReplyEventListeners(card, reply);

    return clone;
  }

  // 댓글 이벤트 리스너
  function setupCommentEventListeners(card, comment) {
    // 좋아요
    card.querySelector('.like-btn').addEventListener('click', () => handleReaction(comment.id, 'like', card));

    // 싫어요
    card.querySelector('.dislike-btn').addEventListener('click', () => handleReaction(comment.id, 'dislike', card));

    // 답글 버튼
    const replyBtn = card.querySelector('.reply-btn');
    const replyForm = card.querySelector('.reply-form');
    const replyInput = card.querySelector('.reply-input');
    const submitReplyBtn = card.querySelector('.submit-reply-btn');
    const cancelReplyBtn = card.querySelector('.cancel-reply-btn');

    replyBtn.addEventListener('click', () => {
      replyForm.classList.toggle('d-none');
      if (!replyForm.classList.contains('d-none')) {
        replyInput.focus();
      }
    });

    cancelReplyBtn.addEventListener('click', () => {
      replyForm.classList.add('d-none');
      replyInput.value = '';
    });

    submitReplyBtn.addEventListener('click', () => submitReply(comment.id, replyInput, replyForm));

    // textarea 자동 높이 조절 및 Enter 전송
    setupTextarea(replyInput, () => submitReply(comment.id, replyInput, replyForm));

    // 수정 버튼
    const editBtn = card.querySelector('.edit-btn');
    const editForm = card.querySelector('.edit-form');
    const editInput = card.querySelector('.edit-input');
    const saveEditBtn = card.querySelector('.save-edit-btn');
    const cancelEditBtn = card.querySelector('.cancel-edit-btn');
    const contentEl = card.querySelector('.comment-content');

    editBtn.addEventListener('click', () => {
      editInput.value = contentEl.textContent;
      contentEl.classList.add('d-none');
      editForm.classList.remove('d-none');
      editInput.focus();
    });

    cancelEditBtn.addEventListener('click', () => {
      editForm.classList.add('d-none');
      contentEl.classList.remove('d-none');
    });

    saveEditBtn.addEventListener('click', () => saveEdit(comment.id, editInput, editForm, contentEl));

    // 삭제 버튼
    card.querySelector('.delete-btn').addEventListener('click', () => deleteComment(comment.id));
  }

  // 대댓글 이벤트 리스너
  function setupReplyEventListeners(card, reply) {
    // 좋아요
    card.querySelector('.like-btn').addEventListener('click', () => handleReaction(reply.id, 'like', card));

    // 싫어요
    card.querySelector('.dislike-btn').addEventListener('click', () => handleReaction(reply.id, 'dislike', card));

    // 수정 버튼
    const editBtn = card.querySelector('.edit-btn');
    const editForm = card.querySelector('.edit-form');
    const editInput = card.querySelector('.edit-input');
    const saveEditBtn = card.querySelector('.save-edit-btn');
    const cancelEditBtn = card.querySelector('.cancel-edit-btn');
    const contentEl = card.querySelector('.reply-content');

    editBtn.addEventListener('click', () => {
      editInput.value = contentEl.textContent;
      contentEl.classList.add('d-none');
      editForm.classList.remove('d-none');
      editInput.focus();
    });

    cancelEditBtn.addEventListener('click', () => {
      editForm.classList.add('d-none');
      contentEl.classList.remove('d-none');
    });

    saveEditBtn.addEventListener('click', () => saveEdit(reply.id, editInput, editForm, contentEl));

    // 삭제 버튼
    card.querySelector('.delete-btn').addEventListener('click', () => deleteComment(reply.id));
  }

  // 댓글 작성
  const submitBtn = document.getElementById('submitBtn');

  commentForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const content = commentInput.value.trim();
    // 텍스트나 이미지 중 하나라도 있어야 함
    if (!content && !selectedImageUrl) {
      alert('댓글 내용을 입력하거나 이미지를 첨부해주세요.');
      return;
    }

    // 버튼 비활성화 및 로딩 표시
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    try {
      console.log('댓글 작성 요청:', { content, image_url: selectedImageUrl });
      const response = await fetch(`/schedules/${scheduleId}/comments`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({ content, image_url: selectedImageUrl })
      });

      const data = await response.json();

      if (data.success) {
        commentInput.value = '';
        commentInput.style.height = 'auto'; // 높이 리셋
        resetImageUpload(); // 이미지 초기화
        loadComments();
      } else {
        alert(data.error || '댓글 작성에 실패했습니다.');
      }
    } catch (error) {
      console.error('댓글 작성 오류:', error);
      alert('댓글 작성 중 오류가 발생했습니다.');
    } finally {
      // 버튼 원상복구
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="bi bi-send"></i>';
    }
  });

  // 답글 작성
  async function submitReply(parentId, input, form) {
    const content = input.value.trim();
    if (!content) return;

    try {
      const response = await fetch(`/schedules/${scheduleId}/comments`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({ content, parent_id: parentId })
      });

      const data = await response.json();

      if (data.success) {
        input.value = '';
        input.style.height = 'auto'; // 높이 리셋
        form.classList.add('d-none');
        loadComments();
      } else {
        alert(data.error || '답글 작성에 실패했습니다.');
      }
    } catch (error) {
      console.error('답글 작성 오류:', error);
      alert('답글 작성 중 오류가 발생했습니다.');
    }
  }

  // 댓글 수정
  async function saveEdit(commentId, input, form, contentEl) {
    const content = input.value.trim();
    if (!content) return;

    try {
      const response = await fetch(`/schedules/comments/${commentId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({ content })
      });

      const data = await response.json();

      if (data.success) {
        contentEl.textContent = content;
        form.classList.add('d-none');
        contentEl.classList.remove('d-none');
      } else {
        alert(data.error || '댓글 수정에 실패했습니다.');
      }
    } catch (error) {
      console.error('댓글 수정 오류:', error);
      alert('댓글 수정 중 오류가 발생했습니다.');
    }
  }

  // 댓글 삭제
  async function deleteComment(commentId) {
    if (!confirm('댓글을 삭제하시겠습니까?')) return;

    try {
      const response = await fetch(`/schedules/comments/${commentId}`, {
        method: 'DELETE',
        headers: { 'X-CSRF-Token': csrfToken }
      });

      const data = await response.json();

      if (data.success) {
        loadComments();
      } else {
        alert(data.error || '댓글 삭제에 실패했습니다.');
      }
    } catch (error) {
      console.error('댓글 삭제 오류:', error);
      alert('댓글 삭제 중 오류가 발생했습니다.');
    }
  }

  // 좋아요/싫어요 처리
  async function handleReaction(commentId, reactionType, card) {
    try {
      const response = await fetch(`/schedules/comments/${commentId}/reaction`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({ reaction_type: reactionType })
      });

      const data = await response.json();

      if (data.success) {
        // UI 업데이트
        const likeBtn = card.querySelector('.like-btn');
        const dislikeBtn = card.querySelector('.dislike-btn');

        card.querySelector('.likes-count').textContent = data.likes;
        card.querySelector('.dislikes-count').textContent = data.dislikes;

        // 버튼 스타일 업데이트
        likeBtn.classList.remove('text-primary');
        dislikeBtn.classList.remove('text-danger');

        if (data.my_reaction === 'like') {
          likeBtn.classList.add('text-primary');
        } else if (data.my_reaction === 'dislike') {
          dislikeBtn.classList.add('text-danger');
        }
      }
    } catch (error) {
      console.error('반응 처리 오류:', error);
    }
  }

  // 시간 포맷
  function formatTime(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;

    if (diff < 60000) return '방금 전';
    if (diff < 3600000) return Math.floor(diff / 60000) + '분 전';
    if (diff < 86400000) return Math.floor(diff / 3600000) + '시간 전';
    if (diff < 604800000) return Math.floor(diff / 86400000) + '일 전';

    return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
  }

  // URL을 클릭 가능한 링크로 변환 + 줄바꿈 처리
  function linkify(text) {
    // HTML 특수문자 이스케이프 (XSS 방지)
    const escapeHtml = (str) => {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    };

    const escaped = escapeHtml(text);

    // URL 패턴 매칭 (http, https, www)
    const urlPattern = /(https?:\/\/[^\s<]+|www\.[^\s<]+)/gi;

    let result = escaped.replace(urlPattern, (url) => {
      const href = url.startsWith('www.') ? 'https://' + url : url;
      return `<a href="${href}" target="_blank" rel="noopener noreferrer" class="text-primary">${url}</a>`;
    });

    // 줄바꿈을 <br>로 변환
    result = result.replace(/\n/g, '<br>');

    return result;
  }

  // 초기 로드
  loadComments();
});
</script>

<%- include('../partials/footer') %>

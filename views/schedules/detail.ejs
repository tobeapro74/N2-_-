<%- include('../partials/header') %>

<div class="d-flex align-items-center mb-4 page-header">
  <a href="/schedules" class="back-link" aria-label="일정 목록으로 이동">
    <i class="bi bi-chevron-left" aria-hidden="true"></i>일정
  </a>
  <nav aria-label="현재 위치" class="mb-0">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item"><a href="/schedules">일정 관리</a></li>
      <li class="breadcrumb-item active" aria-current="page"><%= schedule.course_name %></li>
    </ol>
  </nav>
</div>

<div class="row">
  <!-- 일정 정보 -->
  <div class="col-md-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-calendar-event"></i> 일정 정보</h5>
        <% if (user && user.is_admin) { %>
        <a href="/schedules/<%= schedule.id %>/edit" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-pencil"></i>
        </a>
        <% } %>
      </div>
      <div class="card-body">
        <div class="text-center mb-3">
          <h2 class="text-success mb-0"><%= schedule.course_name %></h2>
          <p class="text-muted"><i class="bi bi-geo-alt"></i> <%= schedule.location %></p>
        </div>
        <table class="table table-borderless">
          <tr>
            <th width="30%">날짜</th>
            <td>
              <strong><%= moment(schedule.play_date).format('YYYY년 MM월 DD일') %></strong>
              <span class="badge bg-secondary"><%= moment(schedule.play_date).format('dddd') %></span>
            </td>
          </tr>
          <tr>
            <th>티타임</th>
            <td><%= schedule.tee_times || '미정' %></td>
          </tr>
          <tr>
            <th>정원</th>
            <td><%= schedule.max_members %>명</td>
          </tr>
          <tr>
            <th>상태</th>
            <td>
              <% if (schedule.status === 'open') { %>
              <span class="badge bg-success">예약가능</span>
              <% } else if (schedule.status === 'closed') { %>
              <span class="badge bg-warning">마감</span>
              <% } else if (schedule.status === 'completed') { %>
              <span class="badge bg-secondary">완료</span>
              <% } else { %>
              <span class="badge bg-danger">취소</span>
              <% } %>
            </td>
          </tr>
          <% if (schedule.notes) { %>
          <tr>
            <th>메모</th>
            <td><%= schedule.notes %></td>
          </tr>
          <% } %>
        </table>

        <!-- 예약 버튼 -->
        <% if (schedule.status === 'open') { %>
        <hr>
        <% if (myReservation) { %>
          <% if (myReservation.status !== 'cancelled') { %>
          <div class="alert alert-success mb-2 text-center">
            <i class="bi bi-check-circle"></i> 예약 신청 완료
            <% if (myReservation.status === 'waitlist') { %>
            <span class="badge bg-warning">대기자</span>
            <% } %>
          </div>
          <button type="button" class="btn btn-outline-danger w-100" onclick="cancelReservation(<%= myReservation.id %>)">
            <i class="bi bi-x-circle"></i> 예약 취소
          </button>
          <% } else { %>
          <% const teeTimesReapply = schedule.tee_times ? schedule.tee_times.split(',').map(t => t.trim()) : []; %>
          <% if (teeTimesReapply.length > 0) { %>
          <div class="mb-2">
            <label class="form-label small text-muted">희망 티타임 선택</label>
            <select id="teeTimeSelect" class="form-select">
              <% teeTimesReapply.forEach((time, idx) => { %>
              <option value="<%= time %>"><%= time %> (<%= idx + 1 %>팀)</option>
              <% }) %>
            </select>
          </div>
          <% } %>
          <button type="button" class="btn btn-success w-100" onclick="applyReservation(<%= schedule.id %>)">
            <i class="bi bi-check-circle"></i> 다시 신청
          </button>
          <% } %>
        <% } else if (user) { %>
        <% const teeTimes = schedule.tee_times ? schedule.tee_times.split(',').map(t => t.trim()) : []; %>
        <% if (teeTimes.length > 0) { %>
        <div class="mb-2">
          <label class="form-label small text-muted">희망 티타임 선택</label>
          <select id="teeTimeSelect" class="form-select">
            <% teeTimes.forEach((time, idx) => { %>
            <option value="<%= time %>"><%= time %> (<%= idx + 1 %>팀)</option>
            <% }) %>
          </select>
        </div>
        <% } %>
        <button type="button" class="btn btn-success w-100" onclick="applyReservation(<%= schedule.id %>)">
          <i class="bi bi-check-circle"></i> 예약 신청
        </button>
        <% } else { %>
        <a href="/auth/login" class="btn btn-outline-success w-100">
          로그인 후 예약
        </a>
        <% } %>
        <% } %>

        <% if (user && user.is_admin && reservations.length > 0) { %>
        <hr>
        <button type="button" class="btn btn-primary w-100" onclick="assignTeams(<%= schedule.id %>)">
          <i class="bi bi-people"></i> 팀 배정
        </button>
        <% } %>
      </div>
    </div>
  </div>

  <!-- 예약자 목록 -->
  <div class="col-md-8">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-people"></i> 예약 현황
          <span class="badge bg-success"><%= reservations.filter(r => r.status !== 'cancelled').length %>/<%= schedule.max_members %></span>
        </h5>
      </div>
      <div class="card-body">
        <% if (reservations.length === 0) { %>
        <p class="text-muted text-center py-4">예약자가 없습니다.</p>
        <% } else { %>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>이름</th>
                <th>부서</th>
                <th>신청시간</th>
                <th>상태</th>
                <th>희망</th>
                <th>팀</th>
                <th>티타임</th>
                <% if (user && user.is_admin) { %>
                <th>관리</th>
                <% } %>
              </tr>
            </thead>
            <tbody>
              <% let seq = 0; %>
              <% reservations.forEach((r, index) => { %>
              <% if (r.status !== 'cancelled') seq++; %>
              <% const isOverCapacity = seq > schedule.max_members && r.status !== 'cancelled'; %>
              <tr class="<%= r.status === 'cancelled' ? 'table-secondary text-decoration-line-through' : '' %>
                         <%= isOverCapacity ? 'table-warning' : '' %>">
                <td><%= r.status !== 'cancelled' ? seq : '-' %></td>
                <td>
                  <strong><%= r.member_name %></strong>
                  <% if (r.priority > 0) { %>
                  <span class="badge bg-info" title="연속 참가자 (후순위)">연속</span>
                  <% } %>
                </td>
                <td><small><%= r.department || '-' %></small></td>
                <td><small><%= moment(r.applied_at).format('MM/DD HH:mm') %></small></td>
                <td>
                  <% if (r.status === 'cancelled') { %>
                  <span class="badge bg-secondary">취소</span>
                  <% } else if (r.status === 'confirmed') { %>
                  <span class="badge bg-success">확정</span>
                  <% } else if (isOverCapacity) { %>
                  <span class="badge bg-danger">대기자</span>
                  <% } else { %>
                  <span class="badge bg-warning">신청</span>
                  <% } %>
                </td>
                <td>
                  <small><%= r.preferred_tee_time || '-' %></small>
                </td>
                <td>
                  <% if (user && user.is_admin && r.status !== 'cancelled') { %>
                  <select class="form-select form-select-sm team-select" data-reservation-id="<%= r.id %>" style="width: 70px;">
                    <option value="">-</option>
                    <% for (let t = 1; t <= 4; t++) { %>
                    <option value="<%= t %>" <%= r.team_number === t ? 'selected' : '' %>><%= t %>팀</option>
                    <% } %>
                  </select>
                  <% } else { %>
                  <%= r.team_number ? r.team_number + '팀' : '-' %>
                  <% } %>
                </td>
                <td>
                  <% if (user && user.is_admin && r.status !== 'cancelled') { %>
                  <input type="time" class="form-control form-control-sm tee-time-input" data-reservation-id="<%= r.id %>" value="<%= r.tee_time || '' %>" style="width: 100px;">
                  <% } else { %>
                  <%= r.tee_time || '-' %>
                  <% } %>
                </td>
                <% if (user && user.is_admin) { %>
                <td>
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteReservation(<%= r.id %>, '<%= r.member_name %>')" title="예약 삭제">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
                <% } %>
              </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <% } %>
      </div>
      <div class="card-footer">
        <small class="text-muted">
          <i class="bi bi-info-circle"></i>
          선착순 12명 예약 가능 (연속 참가자는 후순위 적용)
        </small>
      </div>
    </div>
  </div>
</div>

<script>
// CSRF 토큰
const csrfToken = '<%= csrfToken %>';
const scheduleId = <%= schedule.id %>;
const teeTimes = '<%= schedule.tee_times || "" %>'.split(',').map(t => t.trim()).filter(t => t);

function applyReservation(scheduleId) {
  const teeTimeSelect = document.getElementById('teeTimeSelect');
  const preferredTeeTime = teeTimeSelect ? teeTimeSelect.value : null;

  fetch('/reservations/apply', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken
    },
    body: JSON.stringify({
      schedule_id: scheduleId,
      preferred_tee_time: preferredTeeTime,
      _csrf: csrfToken
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(data.message + (data.isWaitlist ? ' (대기자 명단)' : ''));
      location.reload();
    } else {
      alert(data.error || '오류가 발생했습니다.');
    }
  });
}

function cancelReservation(reservationId) {
  if (!confirm('예약을 취소하시겠습니까?')) return;

  fetch('/reservations/cancel', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken
    },
    body: JSON.stringify({ reservation_id: reservationId, _csrf: csrfToken })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(data.message);
      location.reload();
    } else {
      alert(data.error || '오류가 발생했습니다.');
    }
  });
}

function assignTeams(scheduleId) {
  if (!confirm('팀 배정을 진행하시겠습니까?')) return;

  fetch(`/schedules/${scheduleId}/assign-teams`, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(data.message);
        location.reload();
      } else {
        alert(data.error || '오류가 발생했습니다.');
      }
    });
}

function deleteReservation(reservationId, memberName) {
  if (!confirm(`${memberName}님의 예약을 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) return;

  fetch('/reservations/admin/delete', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken
    },
    body: JSON.stringify({ reservation_id: reservationId, _csrf: csrfToken })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(data.message);
      location.reload();
    } else {
      alert(data.error || '오류가 발생했습니다.');
    }
  });
}

// 팀 변경 함수 (티타임 자동 연동 포함)
function updateTeam(reservationId, teamNumber, teeTime, autoTeeTime = false) {
  return fetch('/reservations/admin/update-team', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken
    },
    body: JSON.stringify({
      reservation_id: reservationId,
      team_number: teamNumber,
      tee_time: teeTime,
      auto_tee_time: autoTeeTime,
      _csrf: csrfToken
    })
  })
  .then(res => res.json());
}

// 팀 균형 정보 조회
function getTeamBalance() {
  return fetch(`/reservations/admin/team-balance/${scheduleId}`)
    .then(res => res.json());
}

// 팀 멤버 교환
function swapTeamMembers(reservationId1, reservationId2, fromTeam) {
  return fetch('/reservations/admin/swap-team', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken
    },
    body: JSON.stringify({
      reservation_id_1: reservationId1,
      reservation_id_2: reservationId2,
      from_team: fromTeam,
      _csrf: csrfToken
    })
  })
  .then(res => res.json());
}

// 팀 교환 모달 표시
function showSwapModal(fromTeam, toTeam, movedReservationId, teamMembers) {
  const toTeamMembers = teamMembers[toTeam] || [];

  if (toTeamMembers.length === 0) {
    alert(`${toTeam}팀에 교환할 멤버가 없습니다.`);
    return;
  }

  let memberOptions = toTeamMembers
    .filter(m => m.id !== movedReservationId)
    .map(m => `<option value="${m.id}">${m.member_name}</option>`)
    .join('');

  const modalHtml = `
    <div class="modal fade" id="swapModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">팀 멤버 교환</h5>
          </div>
          <div class="modal-body">
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle"></i>
              ${toTeam}팀이 5명이 되어 팀 균형이 맞지 않습니다.<br>
              ${toTeam}팀에서 ${fromTeam}팀으로 이동할 멤버를 선택해주세요.
            </div>
            <select class="form-select" id="swapMemberSelect">
              <option value="">-- 멤버 선택 --</option>
              ${memberOptions}
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="cancelSwap(${movedReservationId}, ${toTeam}); return false;">교환 없이 진행</button>
            <button type="button" class="btn btn-primary" onclick="confirmSwap(${movedReservationId}, ${fromTeam}); return false;">멤버 교환</button>
          </div>
        </div>
      </div>
    </div>
  `;

  // 기존 모달 제거
  const existingModal = document.getElementById('swapModal');
  if (existingModal) existingModal.remove();

  // 모달 추가 및 표시
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  const modal = new bootstrap.Modal(document.getElementById('swapModal'));
  modal.show();
}

// 교환 취소 (팀 이동 유지, 교환 없이 진행)
function cancelSwap(movedReservationId, targetTeam) {
  console.log('cancelSwap 호출 - 교환 없이 진행:', movedReservationId, '-> 팀:', targetTeam);

  // 이미 targetTeam으로 이동된 상태이므로, 모달만 닫고 새로고침
  const modalEl = document.getElementById('swapModal');
  const modal = bootstrap.Modal.getInstance(modalEl);
  if (modal) modal.hide();

  alert(`${targetTeam}팀으로 이동되었습니다. (교환 없이 진행)`);
  location.reload();
}

// 교환 확인
function confirmSwap(movedReservationId, fromTeam) {
  const selectEl = document.getElementById('swapMemberSelect');
  const swapReservationId = selectEl.value;

  if (!swapReservationId) {
    alert('교환할 멤버를 선택해주세요.');
    return;
  }

  swapTeamMembers(movedReservationId, parseInt(swapReservationId), fromTeam)
    .then(data => {
      if (data.success) {
        alert(data.message);
        location.reload();
      } else {
        alert(data.error || '오류가 발생했습니다.');
      }
    });
}

// 팀 선택 변경 이벤트
document.querySelectorAll('.team-select').forEach(select => {
  select.addEventListener('change', async function() {
    const reservationId = parseInt(this.dataset.reservationId);
    const newTeamNumber = parseInt(this.value);
    const oldTeamNumber = parseInt(this.dataset.currentTeam) || 0;
    const selectElement = this;
    const row = this.closest('tr');
    const teeTimeInput = row.querySelector('.tee-time-input');

    if (!newTeamNumber) return;

    // 먼저 팀 균형 정보 조회
    const balanceData = await getTeamBalance();

    if (!balanceData.success) {
      alert('팀 정보를 불러올 수 없습니다.');
      this.value = oldTeamNumber || '';
      return;
    }

    const { teamCounts, teamMembers, maxPerTeam } = balanceData;

    // 이동 후 대상 팀의 인원 계산 (현재 인원 + 1, 단 같은 팀 내 이동이면 제외)
    const currentTargetCount = teamCounts[newTeamNumber] || 0;
    const willExceed = oldTeamNumber !== newTeamNumber && currentTargetCount >= maxPerTeam;

    // 팀 변경 실행 (티타임 자동 연동)
    const result = await updateTeam(reservationId, newTeamNumber, null, true);

    if (!result.success) {
      alert(result.error || '오류가 발생했습니다.');
      this.value = oldTeamNumber || '';
      return;
    }

    // 티타임 UI 업데이트
    if (result.tee_time && teeTimeInput) {
      teeTimeInput.value = result.tee_time;
    }

    // 현재 팀 번호 업데이트
    this.dataset.currentTeam = newTeamNumber;

    // 성공 피드백
    selectElement.classList.add('border-success');
    setTimeout(() => selectElement.classList.remove('border-success'), 1000);

    // 팀 균형 검사 - 5명이 되면 교환 모달 표시
    if (willExceed) {
      // 최신 팀 정보 다시 조회
      const updatedBalance = await getTeamBalance();
      if (updatedBalance.success) {
        showSwapModal(oldTeamNumber, newTeamNumber, reservationId, updatedBalance.teamMembers);
      }
    }
  });
});

// 티타임 변경 이벤트
document.querySelectorAll('.tee-time-input').forEach(input => {
  input.addEventListener('change', async function() {
    const reservationId = this.dataset.reservationId;
    const teeTime = this.value;
    const inputElement = this;

    const result = await updateTeam(reservationId, null, teeTime);

    if (result.success) {
      inputElement.classList.add('border-success');
      setTimeout(() => inputElement.classList.remove('border-success'), 1000);
    } else {
      alert(result.error || '오류가 발생했습니다.');
    }
  });
});

// 초기화: 현재 팀 번호 저장
document.querySelectorAll('.team-select').forEach(select => {
  select.dataset.currentTeam = select.value;
});
</script>

<%- include('../partials/footer') %>
